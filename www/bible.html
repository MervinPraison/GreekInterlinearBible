<div class="content white">
<script type="text/javascript">
    setPageTitle ("Interlinear");
    showSearch( doSearchBible );
    showLoader();

    selectedGreekText = localStorage.getItem("TextGreekText");
    if (!selectedGreekText)
    {
        selectedGreekText = "byz";
    }

    if (selectedGreekText == "byz") { bibleLeft = byz; }
    if (selectedGreekText == "ste") { bibleLeft = ste; }
    if (selectedGreekText == "scr") { bibleLeft = scr; }
    if (selectedGreekText == "wch") { bibleLeft = wch; }
                            
    var highlightColors = [ "", "255,255,128,0.5", "255,128,255,0.5", "128,255,255,0.5" ];
                                
    var settingsGreekLayoutTransliterate = localStorage.getItem("LayoutTransliteration");
    var settingsLayoutTextSize = localStorage.getItem("LayoutTextSize");
    if (!settingsLayoutTextSize)
    {
        settingsLayoutTextSize = "12pt";
    }

    var settingsLayoutFontFamily = localStorage.getItem("LayoutFontFamily");
    if (!settingsLayoutFontFamily)
    {
        settingsLayoutFontFamily = "Georgia";
    }
    
    var settingsLayoutColumnWidths = localStorage.getItem("LayoutColumnWidths");
    if (!settingsLayoutColumnWidths)
    {
        settingsLayoutColumnWidths = "600930";
    }

    var settingsLayoutLineSpacing = localStorage.getItem("LayoutLineSpacing");
    if (!settingsLayoutLineSpacing)
    {
        settingsLayoutLineSpacing = "150";
    }

    var settingsLayoutVerseSpacing = localStorage.getItem("LayoutVerseSpacing");
    if (!settingsLayoutVerseSpacing)
    {
        settingsLayoutVerseSpacing = "1em";
    }
    
    var leftColumnWidth = settingsLayoutColumnWidths.substr(0,2) + "%";
    var middleColumnWidth=settingsLayoutColumnWidths.substr(2,2) + "%";
    var rightColumnWidth= settingsLayoutColumnWidths.substr(4,2) + "%";
    
    var passage = "Mat.1";
    var curBook=39;
    if (!localStorage.passage)
    {
        localStorage.passage = passage;
    }
    else
    {
        passage = localStorage.passage;
    }
    var scrollTo = "";
    var highlightText = argsParsed["highlight"];
    var incomingRef = argsParsed["ref"];
    if (incomingRef)
    {
        // we've an incoming passage. Handle with care!
        scrollTo = incomingRef;
        passage = incomingRef.substr(0, incomingRef.lastIndexOf("."));
        console.log ('Forced navigation to ' + passage);
        localStorage.passage = passage; // not sure?
    }
    

    function populateBibleBooks ()
    {
        var bookName = passage.substr(0,3);
        var ihtml = "";
        for (var i=39; i<bibleBooks.length; i++)
        {
            item = "<option %SELECTED% value='%INDEX%'>%BOOK%</option>";
            item = item.replace ( "%BOOK%", bibleBooks[i] ) ;
            item = item.replace ( "%INDEX%", i ) ;
            if (bibleBooks3LC[i] == bookName)
            {
                item = item.replace ( "%SELECTED%", "SELECTED" );
                curBook = i;
            }
            else
            {
                item = item.replace ( "%SELECTED%", "" );
            }
            ihtml = ihtml + item;
        }
            
        $('lstBibleBooks').innerHTML = ihtml;
    }
        
    function populateChapters ( book )
    {
        var bookChapter = passage.substr(4,10);
        var ihtml = "";
        for (var i=0; i<bibleBookChapters[book]; i++)
        {
            item = "<option %SELECTED% value='%INDEX%'>%NUM%</option>";
            item = item.replace ( "%INDEX%", i+1 ) ;
            item = item.replace ( "%NUM%", i+1 ) ;
            if ((i+1) == bookChapter)
            {
                item = item.replace ( "%SELECTED%", "SELECTED" );
            }
            else
            {
                item = item.replace ( "%SELECTED%", "" );
            }
            ihtml = ihtml + item;
        }
            
        $('lstBibleBookChapters').innerHTML = ihtml;
    }
    
    function changePassage()
    {
        var bookName = bibleBooks3LC[$("lstBibleBooks").value];
        var bookChapter = $("lstBibleBookChapters").value;
        if (bookName == "")
        {
            bookName = "Mat";
        }
        if (bookChapter < 1)
        {
            bookChapter = 1;
        }
        if (bookChapter > bibleBookChapters[$("lstBibleBooks").value])
        {
            bookChapter = bibleBookChapters[$("lstBibleBooks").value];
        }
        passage = bookName + "." + bookChapter;
        localStorage.passage = passage;
        loadBiblePassage ( passage );
    }

</script>
    <div id="lstStream">
        Loading...
    </div>
    
<script type="text/javascript">

    function loadBiblePassage ( passage, noscroll )
    {
        setPageTitle (bibleBooks[$("lstBibleBooks").value] + " " + $("lstBibleBookChapters").value)
        var ihtml = "<div style='font-family:" + settingsLayoutFontFamily + "; "
                              + "line-height:" + settingsLayoutLineSpacing + "%; "
                  + "'><div style='font-size:175%; text-align: center; margin:1em; border-bottom:1px dotted #333333;'>" 
                  + bibleBooks[$("lstBibleBooks").value] + " " + $("lstBibleBookChapters").value + "</div>";
        var lhtml = "";
        var rhtml = "";
        var nhtml = "";
        var ref;
        var highlight="";
        var middleText="";
        var highlightNum;
        //alert (ihtml);
        var leftVerse;
        var rightVerse;
        for (var i=1;bibleLeft[passage+"."+i] || bibleRight[passage+"."+i];i++)
        {
            ref = passage+"."+i;
            // define templates
            lhtml = "<div class='greek' style='font-size:%TEXTSIZE%; float: left; width: %LEFTWIDTH%;'>%TEXT%</div>";
            nhtml = "<div style='text-align: center; font-size:150%; color:#556677; float: left; width: %NUMWIDTH%;'>%TEXT%</div>";
            rhtml = "<div class='english' style='font-size:%TEXTSIZE%; float: right; width: %RIGHTWIDTH%;'>%TEXT%</div>";
            
            // process left-hand (greek) side
            leftVerse = (settingsGreekLayoutTransliterate=="on") ? transliterate(bibleLeft[ref]) : bibleLeft[ref];
            rightVerse = bibleRight[ref];
            
            if (highlightText)
            {
                var terms = highlightText.toLowerCase().trim().split(" ");
                for (var k=0;k<terms.length;k++)
                {
                    var p = new RegExp ( "(" + terms[k] + ")", "gi" );
                    leftVerse=leftVerse.replace( p, "<span style='background-color: #FF0;'>$1</span>" );
                    rightVerse=rightVerse.replace( p, "<span style='background-color: #FF0;'>$1</span>" );
                }
            }            
            lhtml = lhtml.replace ( "%TEXT%", leftVerse );
            lhtml = lhtml.replace ( "%TEXTSIZE%", settingsLayoutTextSize );
            lhtml = lhtml.replace ( "%LEFTWIDTH%", leftColumnWidth);

            rhtml = rhtml.replace ( "%TEXT%", rightVerse );
            rhtml = rhtml.replace ( "%TEXTSIZE%", settingsLayoutTextSize );
            rhtml = rhtml.replace ( "%RIGHTWIDTH%", rightColumnWidth);
            
            middleText = "" + i;
            // determine if bookmarked?
            if (localStorage.getItem ("bm_" + ref ))
            {
                middleText = middleText + "</br><img src='./images/tabs/Star.png'/>";
            }
            if (localStorage.getItem ("note_" + ref ))
            {
                middleText = middleText + "</br><img src='./images/tabs/Tag.png'/>";
            }
            
            nhtml = nhtml.replace ( "%TEXT%", middleText);
            nhtml = nhtml.replace ( "%NUMWIDTH%", middleColumnWidth);

            //TODO: highlight class
            //TODO: note indicator
            //TODO: bookmark indicator
            
            // check for a highlight...
            highlight = "";
            if (localStorage.getItem ( "hl_" + ref ))
            {
                highlightNum = localStorage.getItem ( "hl_" + ref );
                highlight = "style='background-color:rgba(";
                highlight = highlight + highlightColors [ highlightNum ];
                highlight = highlight + ")' ";
            }
            
            ihtml = ihtml + "<div " + ((selectedVerse[ref]=="Y") ? "class='verseSelected' " : "") + " " + highlight + " "
                          + "onclick='toggleSelection(this);' id='" + ref + "' style='clear: both'>" + lhtml + nhtml + rhtml + "<div style='clear:both; height:"
                          + settingsLayoutVerseSpacing + ";'></div></div>";
        }
        
        ihtml = ihtml + "</div>";
        // TODO: keyword highlights (from search)
        
        $("lstStream").innerHTML = ihtml;
        resetContentScrollBar();
        
        // TODO: scroll to verse (from search/bookmark/notes, etc.)
        if (!noscroll)
        {
            setTimeout ( function() {
            if (scrollTo)
            {
                sb[sbBody].scrollToElement ($(scrollTo),0);
                scrollTo = null;
            }
            else
            {
                sb[sbBody].scrollTo(0,0);
            }
            },500);
        }
    }
    
   
    function toggleSelection ( o )
    {
        //if ( !ignoreClick ( window.event.clientX, window.event.clientY ) )
        //{
            var ref = o.getAttribute("id");
            selectedVerse [ ref ] = (selectedVerse [ ref ] == "Y" ? "" : "Y" ); // TODO: null?
            $(ref).classList.toggle ( "verseSelected" );
        //}
    }

    var theWord;
    var whichSide;
    onLongPress = function ( event )
    {
        var x = event.touches[0].clientX;
        var y = event.touches[0].clientY;
        var overElement = document.elementFromPoint ( x, y );
        whichSide = 0;
        if (overElement)
        {
            whichSide = (overElement.className=="greek") ? 1 : 2;
        }
        theWord = getWordFromPoint (x,y);
        
        var numSelected = 0;
        var numBookmarked = 0;
        var numNoted = 0;
        var numHighlighted = 0;
        for (i in selectedVerse)
        {
            if ( selectedVerse [i] == "Y" )
            {
                numSelected = numSelected + 1;
                if (localStorage.getItem ("bm_" + i )) { numBookmarked = numBookmarked + 1; }
                if (localStorage.getItem ("note_" + i )) { numNoted = numNoted + 1; }
                if (localStorage.getItem ("hl_" + i )) { numHighlighted = numHighlighted + 1; }
            }
        }
        
        // determine visibility of certain popover elements
        $("cmdDefine").style.display = (theWord && window.navigator.onLine && (whichSide == 2 || (whichSide==1 && settingsGreekLayoutTransliterate!="on") ) ) ? "block" : "none";
        $("cmdSearch").style.display = (theWord) ? "block" : "none";
        $("cmdDefinition").style.display = (theWord && window.navigator.onLine && whichSide==2) ? "block" : "none";
        $("cmdLexiConc").style.display = (theWord && window.navigator.onLine && whichSide==2) ? "block" : "none";
        
        if (numSelected == 0)
        {
            // most things won't work. Sorry!
            $("cmdSelect").style.display = "none";
            $("cmdHighlight1").style.display = "none";
            $("cmdHighlight2").style.display = "none";
            $("cmdHighlight3").style.display = "none";
            $("cmdRemoveHighlight").style.display = "none";
            $("cmdAddBookmark").style.display = "none";
            $("cmdRemoveBookmark").style.display = "none";
            $("cmdAddNote").style.display = "none";    
            $("cmdEditNote").style.display = "none";
            $("cmdRemoveNote").style.display = "none";  
            $("cmdCancel").innerHTML = "Cancel";      
        }
        else
        {
            // we have selected, allow copying and highlighting
            $("cmdSelect").style.display = "block";
            $("cmdHighlight1").style.display = "block";
            $("cmdHighlight2").style.display = "block";
            $("cmdHighlight3").style.display = "block";

            $("cmdRemoveHighlight").style.display = (numHighlighted>0) ? "block" : "none";
            $("cmdAddBookmark").style.display = (numBookmarked < numSelected) ? "block" : "none";
            $("cmdRemoveBookmark").style.display = (numBookmarked>0) ? "block" : "none";
            $("cmdAddNote").style.display = (numNoted < numSelected) ? "block" : "none";            
            $("cmdEditNote").style.display = (numNoted == 1 ) ? "block" : "none";
            $("cmdRemoveNote").style.display = (numNoted>0) ? "block" : "none";        

            $("cmdCancel").innerHTML = "Clear Selection";      
        }
        showPopOver ( "poSelectCommands", x, y);
    }
    
    function copySelection ()
    {
        var s = "";
        for (i in selectedVerse)
        {
            var ref = i;                    
            var vnum = i.substr( i.lastIndexOf(".")+1, 10 );
            if ( selectedVerse [i] == "Y" )
            {                               
                s = s + "\n[" + i + "] " + bibleLeft[i]
                      + "\n[" + i + "] " + bibleRight[i];
            }
        }
        window.plugins.clipboardPlugin.setText ( s );
        cancelSelection();
    }
    
    function addHighlight ( c )
    {
        for (i in selectedVerse)
        {
            if ( selectedVerse [i] == "Y" )
            {
                localStorage.setItem ( "hl_" + i, c ); // store color # to note_ref
                if ($(i))
                {
                    $(i).style.backgroundColor = "rgba(" + highlightColors [c]+")";
                }
            }
        }
        cancelSelection();
    }
    
    function addBookmark ()
    {
        for (i in selectedVerse)
        {
            if ( selectedVerse [i] == "Y" )
            {
                localStorage.setItem ( "bm_" + i, "Y" ); 
            }
        }
        cancelSelection();
        loadBiblePassage ( passage, true );
    }
    
    function removeBookmark ( ref )
    {
        if (ref)
        {
            localStorage.removeItem ( "bm_" + ref );
            loadBiblePassage ( passage, true );
        }
        else
        {
        for (i in selectedVerse)
        {
            if ( selectedVerse [i] == "Y" )
            {
                localStorage.removeItem ( "bm_" + i ); 
            }
        }
        cancelSelection();
        loadBiblePassage ( passage, true );
        }
    }
    
    function removeHighlight ()
    {
        for (i in selectedVerse)
        {
            if ( selectedVerse [i] == "Y" )
            {
                localStorage.removeItem ( "hl_" + i )
                if ($(i))
                {
                    $(i).style.backgroundColor = "transparent";
                }
            }
        }
        cancelSelection();
    }
    
    function cancelSelection()
    {                                               
        for (i in selectedVerse)
        {                                           
            if ( selectedVerse [i] == "Y" )
            {
                selectedVerse[i] = null;
                if ($(i))
                {
                    $(i).classList.toggle("verseSelected");
                }
            }
        }
        selectedVerse = Array();
        hidePopOver();
    }
    
    function define( s )
    {
        // this deals with the currently selected word, set when the popover was triggered.
        var url;
        
        if (whichSide == 1)
        {   // greek
//            url = "http://www.greek-dictionary.net/" + transliterate(theWord);
//            url = "https://www.google.com/search?q=" + transliterate(theWord) + "+site:greek-dictionary.net";
              // try using Perseus
              url = "http://www.perseus.tufts.edu/hopper/searchresults?q=" + transliterate(theWord, betaCode);
        }
        if (whichSide == 2)
        {
            // english
            if (s)
            {
                url = "http://dictionary.reference.com/browse/" + theWord;
            }
            else
            {
                url = "http://www.perseus.tufts.edu/hopper/definitionlookup?type=begin&q=" + theWord + "&target=greek";
            }
            
        }
        hidePopOver();
        if (url)
        {
            openWebPage ( url );
        }
    }
    
    function lexiConc()
    {
        url = "http://www.blueletterbible.org/search/lexiconc.cfm?ss=" + theWord + "&searchtype=any";
        hidePopOver();
        openWebPage(url);
    }
    
    function searchBible()
    {
        // will search the bible for the selected word.
        var url = "./search.html?ignore";
        if (whichSide == 1)
        {
            url = url + "&greek=" + theWord;
        }
        if (whichSide == 2)
        {
            url = url + "&search=" + theWord;
        }
        hidePopOver();
        if (url)
        {
            loadContent(url, updateMainMenu,'slideOut', './bible.html' );
        }
    }

</script>
    <div style="clear: both"></div>
    <br/><br/><br/><br/><br/><br/>
</div>
    <div id="hidePopOver" onclick="hidePopOver ();"></div>
    <div class="popover" id="poSelectCommands">
      <div class="popover-content">
        <div class="arrow"><span></span></div>
        <div class="popover-body">
            <ul class="listGroup" style="margin:0">
                <li class="listItem" id="cmdSelect" onclick="copySelection();">Copy Selection</li>
                <li class="listItem" id="cmdHighlight1" onclick="addHighlight(1);" style="background-color:#FFFF80">Highlight Selection</li>
                <li class="listItem" id="cmdHighlight2" onclick="addHighlight(2);" style="background-color:#FF80FF">Highlight Selection</li>
                <li class="listItem" id="cmdHighlight3" onclick="addHighlight(3);" style="background-color:#80FFFF">Highlight Selection</li>
                <li class="listItem" id="cmdRemoveHighlight" onclick="removeHighlight();">Remove Highlight</li>
                <li class="listItem" id="cmdAddBookmark" onclick="addBookmark();">Add Bookmark...</li>
                <li class="listItem" id="cmdRemoveBookmark" onclick="removeBookmark();">Remove Bookmark(s)...</li>
                <li class="listItem" id="cmdAddNote" onclick="addNote();">Create Note...</li>
                <li class="listItem" id="cmdEditNote" onclick="editNote();">Edit Note...</li>
                <li class="listItem" id="cmdRemoveNote" onclick="removeNote();">Remove Note(s)...</li>
                <li class="listItem" id="cmdSearch" onclick="searchBible();">Search Bible...</li>
                <li class="listItem" id="cmdDefine" onclick="define();">Search Perseus (Online)...</li>
                <li class="listItem" id="cmdDefinition" onclick="define(true);">Definition (Online)...</li>
                <li class="listItem" id="cmdLexiConc" onclick="lexiConc();">BLB LexiConc (Online)...</li>
                <li class="listItem" id="cmdCancel" onclick="cancelSelection();">Cancel Selection</li>
            </ul>
        </div>
      </div>
    </div>

<script>
            setTabBar ( '    <select id="lstBibleBooks" onchange="populateChapters(this.value); changePassage();"><option>...</option></select><select id="lstBibleBookChapters" onchange="changePassage();"><option>...</option></select>');
            showTabBar();



            hideLoader();
            populateBibleBooks(); 
            //TODO: We need to load the chapters for the incoming book.
            populateChapters( curBook );
            loadBiblePassage ( passage );
</script>