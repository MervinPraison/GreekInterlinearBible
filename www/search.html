<div class="content">
    <script>
//        showSearch( doSearchBible ); // no search
        setPageTitle ("Search Results");
    </script>
<!--    <h3>Search Speed</h3>
    <input type="search" id="txtSearch"/> -->
    <div id="lstResults"></div>
<script>



    var englishWord = argsParsed["search"];      // incoming search
    var greekWord = argsParsed["greek"];          // same
    var curPage = argsParsed["page"];
    var scrollTo = argsParsed["scrollto"];
    if (!curPage)
    {
        curPage = 1;
    }
    
    if (!englishWord)
    {
        englishWord = "";
    }
    
    if (!greekWord)
    {
        greekWord = "";
    }
    
    if (!scrollTo)
    {
        scrollTo = "";
    }
    
    console.log ("on search page. args:" + englishWord + ", " + greekWord + ", " + curPage);

    function search( searchArray, searchTerm, allRequired, pageStart, pageEnd, translit )
    {
        var results = Array();
        var terms = searchTerm.split(" ");
        var c = 0;
        for (v in searchArray)
        {
            // search the verse for the searchTerm
            var verse = searchArray[v];
            var tverse = transliterate(searchArray[v]);
            var vhit = 0;
            for (var i=0;i<terms.length;i++)
            {
                if ( verse.toLowerCase().trim().indexOf( terms[i].toLowerCase().trim() ) > -1 )
                {
                    vhit = vhit + 1; // found a hit.
                }
                if (translit)
                {
                    if ( tverse.toLowerCase().trim().indexOf( terms[i].toLowerCase().trim() ) > -1 )
                    {
                        vhit = vhit + 1; // found a hit.
                    }                    
                }
            }
            
            // based on allRequired, we only require 1 or all the terms to be matched
            if (allRequired)
            {
                if (vhit == terms.length)
                {
                    c = c + 1;
                    if (c>=pageStart && c<=pageEnd) { results.push ( v ); }
                }
            }
            else
            {
                if (vhit > 0 )
                {
                    c = c + 1;
                    if (c>=pageStart && c<=pageEnd) { results.push ( v ); }
                }
            }
        }
        return results;
    }
    
    function searchBible ( theWord, whichSide, allRequired, thePage, translit)
    {
        showLoader();
        var page = (thePage) ? thePage : 1;
        var pageStart = ( (page-1) * 100) + 1;
        var pageEnd   = ( page * 100 );
        var searchArray = (whichSide==1) ? bibleLeft : bibleRight;
        
        console.log ( "SearchBible: " + thePage + ", " + pageStart + ", " + pageEnd + ", " + theWord + ", " + whichSide );
        
        var results = search( searchArray, theWord, allRequired, pageStart, pageEnd, translit );
        
        console.log ( "SearchBible: " + results.length );
        
        var ihtml = "<div class='listGroup'>";
       
        for (var i=0;i<results.length;i++)
        {
            var ref = results[i];
            var topText = (whichSide==1) ? bibleLeft[ref] : bibleRight[ref];
            var bottomText = (whichSide==1) ? bibleRight[ref] : bibleLeft[ref];
            //TODO: need to follow transliteration setting
            
            var terms = theWord.toLowerCase().trim().split(" ");
            for (var k=0;k<terms.length;k++)
            {
                var p = new RegExp ( "(" + terms[k] + ")", "gi" );
                topText=topText.replace( p, "<span style='background-color: #FF0;'>$1</span>" );
                bottomText=bottomText.replace( p, "<span style='background-color: #FF0;'>$1</span>" );
            }
            
            var url = 'loadContent("./bible.html?ignore&ref=' + ref + '&highlight=' + theWord +'", updateMainMenu,"slideOut", "./search.html?ignore&' + 
                      'search=' + englishWord + '&' +
                      'greek=' + greekWord + '&' +
                      'page=' + curPage + '&' +
                      'scrollto=item' + i +
                      '");'
            var item = "<a id='item%NUM%' class='listItem arrow' href='#' onclick='%LINK%'><span style='display: block; float:left; width:15%'>%REF%</span><span style='width:84%; display: block; float:right;'><span style='display: block'>%TOP%</span><span style='display: block'>%BOTTOM%</span></span><span style='display: block; clear: both'></span></a>";
            item = item.replace ( "%REF%", ref);
            item = item.replace ( "%TOP%", topText);
            item = item.replace ( "%BOTTOM%", bottomText);
            item = item.replace ( "%LINK%", url);
            item = item.replace ( "%NUM%", i );
            //console.log (item);
            ihtml = ihtml + item;
        }
        
        ihtml = ihtml + "</div>";
        
        $("lstResults").innerHTML = ihtml;
        resetContentScrollBar((scrollTo ? 1125 : 500));
        setTimeout (function() {
        if (scrollTo)
        {
            sb[sbBody].scrollToElement ($(scrollTo),0);
            scrollTo = null;
        }
        },1250);
        hideLoader();
    }
    
    function searchStart()
    {
    
        if (englishWord || greekWord)
        {
            if (englishWord)
            {
                console.log ("searching english");
                searchBible ( englishWord, 2, true, curPage, false );
            }
            else
            {
                console.log ("searching greek");
                searchBible ( greekWord, 1, true, curPage, true);
            }
        }
    
    }

    // load our selected bibles
            selectedGreekText = localStorage.getItem("TextGreekText");
            if (!selectedGreekText)
            {
                selectedGreekText = "byz";
            }
            selectedRightText = localStorage.getItem("TextRightText");
            if (!selectedRightText)
            {
                selectedRightText = "ylt";
            }
    afterBothLoaded = searchStart;
    leftLoaded = false; rightLoaded = false;
    loadBible ( selectedGreekText );
    loadBible ( selectedRightText );

</script>
</div>
