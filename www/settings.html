<div class="content">
    <script>
//        showSearch( doSearchBible );
        setPageTitle ("Settings");
        
var fileImportExport = function( filename )
{
    var self = this;
    self.filename = filename;

    self.matchKeys = Array();   // these are localStorage keys that will be sync'd

    self.addMatchKey = function ( v )
    {
        self.matchKeys.push ( v );
    }
    
    /**
     * Called when the filesystem is successfully returned. Will attempt to get the filename
     * access (and create it if necesssary).
     */
    self.gotFStoWrite = function (fileSystem)
    {
        fileSystem.root.getFile(self.filename, {create: true, exclusive: false}, self.gotFileEntrytoWrite, self.fail);
    }
    
    /**
     *
     * Called when the filesystem is successfully returned. It will attempt to open filename for
     * read-only access.
     */
    self.gotFStoRead = function (fileSystem)
    {
        fileSystem.root.getFile(self.filename, null, self.gotFileEntrytoRead, self.fail);
    }
    
    /**
     *
     * Called when file is obtained for writing. It will create a fileWriter
     * which will actually write the contents of localStorage.
     */
    self.gotFileEntrytoWrite = function (fileEntry)
    {
        fileEntry.createWriter (self.gotFileWriter, self.fail);
    }

    /**
     *
     * Called when file is obtained for reading. It will create a fileReader
     * which will read the contents of the file into localStorage.
     */
    self.gotFileEntrytoRead = function (fileEntry)
    {
        fileEntry.file (self.gotFileReader, self.fail);
    }
    
    /**
     *
     * Called when the file file is successfully opened for reading.
     * Parses the file by splitting it into key/value pairs, and then splitting
     * those pairs into the key and the value. It then saves them to localStorage
     * using localStorage.setItem(). 
     *
     * NOTE: localStorage is /not/ cleared when this file is loaded.
     */
    self.gotFileReader = function (file)
    {
        var reader = new FileReader();
        reader.onloadend = function (evt) { 
            if (consoleLogging) { console.log ("Importing localStorage from " + self.filename ); }
            var ls = evt.target.result.split("[EOK]");
            for (var i=0;i<ls.length;i++)
            {
                var kv = ls[i].split("[EQ]");
                for (var j=0; j<self.matchKeys.length; j++)
                {
                    var re = new RegExp ( self.matchKeys[j], "gi" );
                    if ( kv[0].match ( re ) )
                    {
                        localStorage.setItem ( kv[0], kv[1] );
                    }
                }
            }
            if (consoleLogging) { console.log ("Import complete."); }
            if (self.readCallback)
            {
                self.readCallback();
            }
        };
        reader.readAsText (file);
    }

    /**
     *
     * Called when file is open for writing and created if necessary.
     * Writes out each value in localStorage as a key/value pair.
     */
    self.gotFileWriter = function (writer)
    {
        if (consoleLogging) { console.log ("Exporting localStorage to " + self.filename); }
        
        var s = "";
        
        for (var i=0; i<localStorage.length; i++)
        {
            var key = localStorage.key(i);
            var value = localStorage[key];
            for (var j=0; j<self.matchKeys.length; j++)
            {
                var re = new RegExp ( self.matchKeys[j], "gi" );
                if ( key.match ( re ) )
                {
                    s = s + key + "[EQ]" + value + "[EOK]";
                }
            }
        }
        writer.write ( s );
        
        if (consoleLogging) { console.log ("Export Complete."); }
        
        if (self.writeCallback)
        {
            self.writeCallback();
        }
    }

    /**
     *
     * If an error should occur during a read or write operation,
     * we will display the error. If a readCallback() is defined,
     * call it.
     */
    self.fail = function (error)
    {
        console.log ("Error: " + error.code);
            if (self.readCallback)
            {
                self.readCallback( error );
            }
    }

    /**
     *
     * Kicks off a save operation. If callback is specified,
     * it is called when the save operation is complete.
     */
    self.write = function ( callback )
    {
        if (callback)
        {
            self.writeCallback = callback;
        }
        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, self.gotFStoWrite, self.fail);
    }
    
    /**
     *
     * Kicks off a read operation. if callback is defined,
     * it is called when the operation is complete OR a read error
     * occurs.
     */
    self.read = function( callback )
    {
        if (callback)
        {
            self.readCallback = callback;
        }
        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, self.gotFStoRead, self.fail);
    }
}        
       
function generateExport ( whichStuff )
{
    console.log ("Starting export...");
    var filename = "export_";
    var now = new Date();
    filename += now.format ("yyyymmdd_HHMMss");
    filename += ".dat";

    console.log ("... filename is " + filename);
    
    var exporter = new fileImportExport ( filename );
    
    switch (whichStuff)
    {
        case 1:    // export notes only
                exporter.addMatchKey ( "note\_.*" ); 
                break;
        case 2:     // export bookmarks only
                exporter.addMatchKey ( "bm\_.*" );
                break;
        case 3:     // export highlights only
                exporter.addMatchKey ( "hl\_.*" );
                break;
        default:    // export everything, including settings
                exporter.addMatchKey ( ".*" );
                break;
    }
    console.log ("... finished adding keys...");
    
    exporter.write ( function() { navigator.notification.alert ("Export completed successfully.", null, "Export Status" );} );
}

function generateImport ( whichStuff )
{
    var filename = "import.dat";
    var importer = new fileImportExport ( filename );
 
    switch (whichStuff)
    {
        case 1:    // import notes only
                importer.addMatchKey ( "note\_.*" ); 
                break;
        case 2:     // import bookmarks only
                importer.addMatchKey ( "bm\_.*" );
                break;
        case 3:     // import highlights only
                importer.addMatchKey ( "hl\_.*" );
                break;
        default:    // import everything, including settings
                importer.addMatchKey ( ".*" );
                break;
    }
    
    importer.read ( function( e ) 
                    {
                        if (!e)
                        { 
                            navigator.notification.alert ("Import completed successfully.", null, "Import Status" );
                            cls.updatedItem(); // tell the cloud we got new stuff!
                        }
                        else
                        {
                            navigator.notification.alert ("Import encountered an error.", null, "Import Status" );
                        }
                    } );
       
}


    </script>
    <h3>Text</h3>
    <ul class="listGroup">
        <li class="listItem">Greek Text
            <select id="ddGreekText" class="dropdown" default="byzp" localStorage="TextGreekText">
                <option value="byz">Byzantine (2000)</option>
                <option value="byzp">Byzantine (2000) Parsed</option>
                <option value="tr">Textus Receptus (1894)</option>
                <option value="trp">Textus Receptus (1894) Parsed</option>
                <option value="tis">Tischendorf 8th Edition</option>
                <option value="wch">Westcott-Hort</option>
                <option value="wchp">Westcott-Hort Parsed</option>
            </select>
        </li>
        <li class="listItem">English Text
            <select id="ddRightText" class="dropdown" default="ylt" localStorage="TextRightText">
                <option value="kjv">King James Version/Authorized Version</option>
                <option value="ylt">Young's Literal Translation</option>
            </select>
        </li>
        <li class="listItem">Show Notes Inline<div class="switch"><span class="thumb"></span><input type="checkbox" localStorage="LayoutInlineNotes"/></div></li>
        <li class="listItem">English Transliteration<div class="switch"><span class="thumb"></span><input type="checkbox" localStorage="LayoutTransliteration"/></div></li>
    </ul>
    <h3>Layout</h3>
    <ul class="listGroup">
        <li class="listItem">Column Width
            <select id="ddColumnWidths" class="dropdown" default="600930" localStorage="LayoutColumnWidths">
                <option value="600930">Wide Greek Column</option>
                <option value="300960">Wide English Column</option>
                <option value="450945">Equal Width Columns</option>
            </select>
        </li>
        <li class="listItem">Text Size
            <select id="ddTextSize" class="dropdown" default="12" localStorage="LayoutTextSize">
                <option value="8">Tiny Print</option>
                <option value="10">Smaller Print</option>
                <option value="12">Small Print</option>
                <option value="14">Normal Print</option>
                <option value="16">Large Print</option>
                <option value="18">Larger Print</option>
                <option value="20">Extra Large Print</option>
                <option value="22">Huge Print</option>
                <option value="24">Humongous Print</option>
            </select>
        </li>
        <li class="listItem">Typeface
            <select id="ddTypeface" class="dropdown" default="Helvetica" localStorage="LayoutFontFamily">
                <option value="Arial">Arial</option>
                <option value="Courier">Courier</option>
                <option value="Georgia">Georgia</option>
                <option value="Helvetica">Helvetica</option>
                <option value="Palatino">Palatino</option>
                <option value="Times">Times</option>
                <option value="Verdana">Verdana</option>
            </select>
        </li>
        <li class="listItem">Line Spacing
            <select id="ddLineSpacing" class="dropdown" default="75" localStorage="LayoutLineSpacing">
                <option value="50">Tightest Spacing</option>
                <option value="66">Tighter Spacing</option>
                <option value="75">Tight Spacing</option>
                <option value="100">Normal Spacing</option>
                <option value="125">One and one-half Spacing</option>
                <option value="150">Double Spacing</option>
            </select>
        </li>
    </ul>
    <h3>iCloud</h3>
    <ul class="listGroup">
        <li class="listItem">Use iCloud<div class="switch"><span class="thumb"></span><input type="checkbox" localStorage="settingsUseCloud"/></div></li>        
    </ul>
    <p style="text-align: center">Enabling iCloud will permit you to keep your notes, bookmarks, and
                                  highlights in sync across all your devices. It is suggested you export your content
                                  prior to turning on iCloud.</p>    
    <h3>Import / Export</h3>
    <ul class="listGroup">
        <li class="listItem" onclick="generateExport(0);" >Export...</li>
    </ul>
    <p style="text-align: center">Export will create a file (export_YYYYMMDD_HHMMSS.dat) that you can
                                  download when you connect your device to iTunes. It contains
                                  all your settings, notes, bookmarks, and highlights.</p>
        
    <ul class="listGroup">
        <li class="listItem" onclick="generateImport(1);" >Import Notes...</li>
        <li class="listItem" onclick="generateImport(2);" >Import Bookmarks...</li>
        <li class="listItem" onclick="generateImport(3);" >Import Highlights...</li>
        <li class="listItem" onclick="generateImport(0);" >Import Everything...</li>
    </ul>
    <p style="text-align: center">Before importing, connect your device to iTunes, and then copy the file
                                  you want to import. Be sure to name it "import.dat", or the import will
                                  fail.</p>

    <script>
    onPageLoaded = function ()
    {
        processCheckBoxes();
        processDropDowns();
    }
    </script>
</div>
